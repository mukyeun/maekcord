import React, { useState, useEffect, useRef } from 'react';
import { Spin, Alert, Descriptions, Tag, Row, Col, Typography, Card, Modal, Button, Progress } from 'antd';
import { FileTextOutlined, MedicineBoxOutlined, BulbOutlined, LineChartOutlined, HeartOutlined, ShareAltOutlined, PrinterOutlined, FilePdfOutlined } from '@ant-design/icons';
import * as pulseApi from '../api/pulseApi';
import html2pdf from 'html2pdf.js';
import { useReactToPrint } from 'react-to-print';
import styled from 'styled-components';

const { Title, Text, Paragraph } = Typography;

// Ïû•Î∂ÄÎ≥Ñ Ïù¥Î™®Ìã∞ÏΩò+ÌïúÍ∏Ä(ÏòÅÎ¨∏) Îß§Ìïë
const ORGAN_LABELS = {
  cardiovascular: { emoji: '‚ù§Ô∏è', label: 'Ïã¨ÌòàÍ¥Ä(Cardiovascular)' },
  respiratory: { emoji: 'ü´Å', label: 'Ìò∏Ìù°Í∏∞(Respiratory)' },
  renal: { emoji: 'ü©∏', label: 'Ïã†Ïû•(Renal)' },
  musculoskeletal: { emoji: 'üí™', label: 'Í∑ºÍ≥®Í≤©(Musculoskeletal)' },
  dermatologic: { emoji: 'üßë‚Äçü¶≤', label: 'ÌîºÎ∂Ä(Dermatologic)' },
  gastrointestinal: { emoji: 'üçΩÔ∏è', label: 'ÏÜåÌôîÍ∏∞(Gastrointestinal)' },
  neurological: { emoji: 'üß†', label: 'Ïã†Í≤ΩÍ≥Ñ(Neurological)' },
  endocrine: { emoji: 'ü¶ã', label: 'ÎÇ¥Î∂ÑÎπÑ(Endocrine)' },
  ophthalmologic: { emoji: 'üëÅÔ∏è', label: 'ÏïàÍ≥º(Ophthalmologic)' },
  reproductive: { emoji: '‚ößÔ∏è', label: 'ÏÉùÏãùÍ∏∞(Reproductive)' },
  hematologic: { emoji: 'ü©∏', label: 'ÌòàÏï°(Hematologic)' },
  immune: { emoji: 'üõ°Ô∏è', label: 'Î©¥Ïó≠Í≥Ñ(Immune)' },
  ent: { emoji: 'üëÇ', label: 'Ïù¥ÎπÑÏù∏ÌõÑÍ≥º(ENT)' },
  // Í∏∞ÌÉÄ Ï∂îÍ∞Ä Í∞ÄÎä•
};

const SectionCard = ({ title, icon, children, style, bodyStyle }) => (
  <Card 
    title={<span>{icon} {title}</span>} 
    bordered={false} 
    style={style}
    bodyStyle={bodyStyle}
  >
    {children}
  </Card>
);

const PulseInfoModal = ({ isOpen, onClose, pulseType, patientPulseData }) => {
  const [pulseData, setPulseData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const printRef = useRef();

  useEffect(() => {
    const fetchPulseInfo = async () => {
      if (!pulseType) return;
      setLoading(true);
      setError(null);
      try {
        const response = await pulseApi.getPulseProfileByName(pulseType);
        if (response.data.success) {
          setPulseData(response.data.data);
        } else {
          setError(response.data.message);
        }
      } catch (err) {
        console.error('Îß•ÏÉÅ Ï†ïÎ≥¥ Ï°∞Ìöå Ïò§Î•ò:', err);
        setError('Îß•ÏÉÅ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      } finally {
        setLoading(false);
      }
    };

    if (isOpen) {
      fetchPulseInfo();
    }
  }, [isOpen, pulseType]);

  // Ïã§Ï†ú ÌôòÏûê Ï∏°Ï†ï Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
  const getPulseValues = () => {
    // Ïã§Ï†ú ÌôòÏûê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©
    if (patientPulseData) {
      return {
        PVC: patientPulseData.PVC || 50,
        BV: patientPulseData.BV || 60,
        SV: patientPulseData.SV || 70,
        HR: patientPulseData.HR || 80
      };
    }

    // ÌôòÏûê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Îß•ÏÉÅ ÌÉÄÏûÖÏóê Îî∞Îùº ÏòàÏãúÍ∞í ÏÑ§Ï†ï
    const baseValues = {
      PVC: 50, // Ï§ëÍ∞ÑÍ∞í (Î∂Ä-Ï§ë-Ïπ®)
      BV: 60,  // Ï§ëÍ∞ÑÍ∞í (Ìôú-Ï§ë-ÏÇΩ)
      SV: 70,  // Ï§ëÍ∞ÑÍ∞í (Ìóà-Ï§ë-Ïã§)
      HR: 80   // Ï§ëÍ∞ÑÍ∞í (ÏßÄ-Ï§ë-ÏÇ≠)
    };

    // Îß•ÏÉÅ ÌÉÄÏûÖÏóê Îî∞Îùº Í∞í Ï°∞Ï†ï (ÏòàÏãú)
    if (pulseType?.includes('Î∂Ä')) {
      baseValues.PVC = 30; // Î∂ÄÎß•: ÎÇÆÏùÄ Í∞í
    }
    if (pulseType?.includes('Ïπ®')) {
      baseValues.PVC = 70; // Ïπ®Îß•: ÎÜíÏùÄ Í∞í
    }
    if (pulseType?.includes('Ìôú')) {
      baseValues.BV = 40; // ÌôúÎß•: ÎÇÆÏùÄ Í∞í
    }
    if (pulseType?.includes('ÏÇΩ')) {
      baseValues.BV = 80; // ÏÇΩÎß•: ÎÜíÏùÄ Í∞í
    }
    if (pulseType?.includes('Ìóà')) {
      baseValues.SV = 50; // ÌóàÎß•: ÎÇÆÏùÄ Í∞í
    }
    if (pulseType?.includes('Ïã§')) {
      baseValues.SV = 90; // Ïã§Îß•: ÎÜíÏùÄ Í∞í
    }
    if (pulseType?.includes('ÏßÄ')) {
      baseValues.HR = 60; // ÏßÄÎß•: ÎÇÆÏùÄ Í∞í
    }
    if (pulseType?.includes('ÏÇ≠')) {
      baseValues.HR = 100; // ÏÇ≠Îß•: ÎÜíÏùÄ Í∞í
    }

    return baseValues;
  };

  const pulseValues = getPulseValues();
  
  const normalRanges = {
    PVC: { min: 60, max: 90 },
    BV: { min: 7, max: 10 },
    SV: { min: 55, max: 70 },
    HR: { min: 65, max: 85 }
  };

  const getBarValue = (key, value) => {
    const { min, max } = normalRanges[key];
    if (value === undefined) return 0;
    const avg = (min + max) / 2;
    const maxDist = max - avg;
    const minDist = avg - min;
    
    if (value >= avg && maxDist !== 0) {
      return (value - avg) / maxDist;
    } else if (value < avg && minDist !== 0) {
      return -((avg - value) / minDist);
    }
    return 0;
  };

  const getBarColor = (ratio) => {
    if (ratio > 0.7) return '#FF6B6B'; // Í∞ïÌïòÍ≤å ÎÜíÏùå(Î†àÎìú)
    if (ratio > 0.3) return '#FFB347'; // ÏïΩÍ∞Ñ ÎÜíÏùå(Ïò§Î†åÏßÄ)
    if (ratio < -0.7) return '#4FC3F7'; // Í∞ïÌïòÍ≤å ÎÇÆÏùå(Î∏îÎ£®)
    if (ratio < -0.3) return '#00B8A9'; // ÏïΩÍ∞Ñ ÎÇÆÏùå(ÎØºÌä∏)
    return '#BDBDBD'; // ÌèâÍ∑† Í∑ºÏ≤ò(Í∑∏Î†àÏù¥)
  };

  const BarWrapper = styled.div`
    position: relative;
    width: 120px;
    height: 18px;
    background: #F5F7FA;
    border-radius: 9px;
    margin: 0 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.08);
    transition: all 0.3s ease;
    
    &:hover {
      box-shadow: 0 4px 16px rgba(24, 144, 255, 0.15);
      transform: translateY(-1px);
    }
  `;

  const BarFill = styled.div`
    position: absolute;
    top: 0;
    left: 50%;
    height: 100%;
    border-radius: 9px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                background 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s ease;
    animation: slideIn 0.8s ease-out;
    
    @keyframes slideIn {
      from {
        width: 0;
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  `;

  const ValueLabel = styled.span`
    font-weight: bold;
    color: #222;
    margin-left: 8px;
    transition: all 0.3s ease;
  `;

  const PulseBar = ({ ratio, value, color }) => (
    <BarWrapper>
      <BarFill
        style={{
          width: `${Math.abs(ratio) * 50}%`,
          background: color,
          left: ratio < 0 ? `calc(50% - ${Math.abs(ratio) * 50}%)` : '50%',
          boxShadow: `0 2px 8px ${color}33`,
        }}
      />
      <div style={{
        position: 'absolute', left: '50%', top: 0, width: 2, height: '100%',
        background: '#888', zIndex: 2
      }} />
      <ValueLabel style={{
        position: 'absolute',
        top: -24,
        left: ratio < 0 ? `calc(50% - ${Math.abs(ratio) * 50}%)` : `calc(50% + ${Math.abs(ratio) * 50}%)`,
        transform: 'translateX(-50%)',
        color: color,
        fontSize: 15,
        textShadow: '0 2px 8px #fff',
        fontWeight: 600,
      }}>
        {value}
      </ValueLabel>
    </BarWrapper>
  );

  // Ïò¨Î∞îÎ•∏ Î∂ÑÎ•ò Í∏∞Ï§ÄÏóê ÎßûÍ≤å ÏàòÏ†ï
  const pulseTypes = {
    PVC: 'Î∂Ä-Ï§ë-Ïπ®Îß•',
    BV: 'Ìôú-Ï§ë-ÏÇΩÎß•',
    SV: 'Ìóà-Ï§ë-Ïã§Îß•',
    HR: 'ÏßÄ-Ï§ë-ÏÇ≠Îß•'
  };

  // Í∞íÏóê Îî∞Î•∏ Î∂ÑÎ•ò Í≤∞Ï†ï Ìï®Ïàò
  const getClassification = (key, value) => {
    const { min, max, avg } = normalRanges[key];
    if (value === undefined) return 'Ï§ë';
    
    const range = max - min;
    const deviation = value - avg;
    const deviationPercent = (deviation / (range / 2)) * 100;
    
    switch (key) {
      case 'PVC': // Î∂Ä-Ï§ë-Ïπ®
        if (deviationPercent < -30) return 'Î∂Ä';
        if (deviationPercent > 30) return 'Ïπ®';
        return 'Ï§ë';
      case 'BV': // Ìôú-Ï§ë-ÏÇΩ
        if (deviationPercent < -30) return 'Ìôú';
        if (deviationPercent > 30) return 'ÏÇΩ';
        return 'Ï§ë';
      case 'SV': // Ìóà-Ï§ë-Ïã§
        if (deviationPercent < -30) return 'Ìóà';
        if (deviationPercent > 30) return 'Ïã§';
        return 'Ï§ë';
      case 'HR': // ÏßÄ-Ï§ë-ÏÇ≠
        if (deviationPercent < -30) return 'ÏßÄ';
        if (deviationPercent > 30) return 'ÏÇ≠';
        return 'Ï§ë';
      default:
        return 'Ï§ë';
    }
  };

  const renderContent = () => {
    if (loading) return <div style={{ textAlign: 'center', padding: '48px 0' }}><Spin size="large" tip="Îß•ÏÉÅ Ï†ïÎ≥¥ Î°úÎî© Ï§ë..." /></div>;
    if (error) return <Alert message="Ïò§Î•ò" description={error} type="error" showIcon />;
    if (!pulseData) return <Alert message="ÏÑ†ÌÉùÎêú Îß•ÏÉÅ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§." type="info" showIcon />;

    const {
      hanja, description, origin, relatedDiseases, management,
      physiology, systemicImpacts
    } = pulseData;

    return (
      <Row gutter={[8, 8]}>
        <Col span={24}>
          <Title level={3} style={{ marginTop: 0 }}>
            {pulseType}
            {hanja && <Text type="secondary" style={{ marginLeft: 8, fontSize: '1.2rem' }}>{hanja}</Text>}
          </Title>
          <Paragraph type="secondary">{description}</Paragraph>
        </Col>

        <Col span={24}>
          <SectionCard
            title="Îß•ÏÉÅ ÏñëÏÉÅ"
            icon={<FileTextOutlined />}
            style={{ marginBottom: 8 }}
            bodyStyle={{ padding: 8 }}
          >
            <Descriptions column={1} bordered size="small">
              {Object.entries(pulseValues).map(([key, value]) => {
                const classification = getClassification(key, value);
                const ratio = getBarValue(key, value);
                const color = getBarColor(ratio);
                
                return (
                  <Descriptions.Item
                    key={key}
                    label={`${key} (${pulseTypes[key]}, ${classification}Îß•)`}
                    labelStyle={{ width: 180, minWidth: 150, maxWidth: 220, whiteSpace: 'normal' }}
                    contentStyle={{ textAlign: 'center', padding: '0 8px' }}
                  >
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <PulseBar
                        ratio={ratio}
                        value={value}
                        color={color}
                      />
                      <Tag 
                        color={ratio > 0.3 ? 'red' : ratio < -0.3 ? 'blue' : 'green'} 
                        size="small" 
                        style={{ marginLeft: 8 }}
                      >
                        {classification}Îß•
                      </Tag>
                    </div>
                  </Descriptions.Item>
                );
              })}
            </Descriptions>
          </SectionCard>

          <SectionCard title="Í¥ÄÎ¶¨ Î∞è ÏπòÎ£å" icon={<MedicineBoxOutlined />}>
            {management && management.herbal && (
              <>
                <Title level={5}>Ï∂îÏ≤ú ÏïΩÏû¨</Title>
                <Paragraph>{management.herbal.join(', ')}</Paragraph>
              </>
            )}
            {management && management.acupuncture && (
               <>
                <Title level={5}>Ï£ºÏöî Í≤ΩÌòà</Title>
                <Paragraph>{management.acupuncture.join(', ')}</Paragraph>
              </>
            )}
            {management && management.lifestyle && (
               <>
                <Title level={5}>ÏÉùÌôúÏäµÍ¥Ä Í∞ÄÏù¥Îìú</Title>
                <Paragraph>{management.lifestyle.join(', ')}</Paragraph>
              </>
            )}
          </SectionCard>
        </Col>
        
        <Col span={24}>
           <SectionCard title="Ïû•Î∂ÄÎ≥Ñ ÏÉÅÏÑ∏ ÏòÅÌñ•" icon={<ShareAltOutlined />}>
            {systemicImpacts && (
              <Descriptions layout="vertical" bordered>
                {Object.entries(systemicImpacts).map(([organ, symptoms]) => {
                  const organInfo = ORGAN_LABELS[organ] || { emoji: '', label: organ };
                  return (
                    <Descriptions.Item key={organ} label={<span>{organInfo.emoji} {organInfo.label}</span>}>
                      {Array.isArray(symptoms) ? symptoms.join(', ') : symptoms}
                    </Descriptions.Item>
                  );
                })}
              </Descriptions>
            )}
          </SectionCard>
        </Col>
      </Row>
    );
  };

  // PDF Ï†ÄÏû• Ìï®Ïàò
  const handleSavePdf = () => {
    if (printRef.current) {
      html2pdf().from(printRef.current).save('Îß•ÏÉÅÏÉÅÏÑ∏Ï†ïÎ≥¥.pdf');
    }
  };

  // Ïù∏ÏáÑ Ìï®Ïàò
  const handlePrint = useReactToPrint({
    content: () => printRef.current,
    documentTitle: 'Îß•ÏÉÅÏÉÅÏÑ∏Ï†ïÎ≥¥',
  });

  return (
    <Modal
      title="Îß•ÏÉÅ ÏÉÅÏÑ∏ Ï†ïÎ≥¥"
      visible={isOpen}
      onCancel={onClose}
      footer={[
        <Button key="close" onClick={onClose}>
          Îã´Í∏∞
        </Button>
      ]}
      width={1000}
      centered
      destroyOnClose
    >
      {/* Ïù∏ÏáÑÏö© ÏÉÅÎã® Î≥ëÏõêÎ™Ö */}
      <div className="print-only" style={{ display: 'none', textAlign: 'center', marginBottom: 24, fontSize: 24, fontWeight: 700 }}>
        ÎèÑÏõêÌïúÏùòÏõê
      </div>
      <div className="print-hide" style={{ marginBottom: 16, textAlign: 'right' }}>
        <Button
          type="primary"
          icon={<FilePdfOutlined />}
          onClick={handleSavePdf}
          style={{ marginRight: 8 }}
        >
          PDFÎ°ú Ï†ÄÏû•
        </Button>
        <Button
          type="default"
          icon={<PrinterOutlined />}
          onClick={handlePrint}
        >
          Ïù∏ÏáÑ
        </Button>
      </div>
      <div ref={printRef}>
        {error && (
          <Alert message="Ïò§Î•ò" description={error} type="error" showIcon style={{ marginBottom: 16 }} />
        )}
        <Spin spinning={loading} tip="Î∂àÎü¨Ïò§Îäî Ï§ë...">
          {renderContent()}
        </Spin>
        {/* Ïù∏ÏáÑÏö© ÌïòÎã® ÏïàÎÇ¥Î¨∏Íµ¨ */}
        <div className="print-only" style={{ display: 'none', textAlign: 'center', marginTop: 32, fontSize: 16, color: '#888' }}>
          Î¨∏Ïùò: 051-612-0120
        </div>
      </div>
    </Modal>
  );
};

export default PulseInfoModal; 